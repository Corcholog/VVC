<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/styles/mapa.css">
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
    <nav id="nav_g">
        <a href="home" class="nav_item_l"> BUENAS TARDES </a>
        <a href="login" class="nav_item_l"> Log in </a>
        <a href="signup" class="nav_item_l"> Sign up </a>
        <a href="about" class="nav_item_l"> Â¿QuiÃ©nes somos? </a>
        <a class="nav_item_r"> ðŸ”Ž </a>
        <a class="nav_item_r"> ðŸ”Ž </a>
        <a class="nav_item_r"> ðŸ”Ž </a>
        <a class="nav_item_r"> ðŸ”Ž </a>
    </nav>
    <br>
    <div>
        <h3 style="text-align: center; width: 70%;">Buscar producto</h3>
        <form id="searchForm" autocomplete="off">
            <input type="text" id="query" name="query" placeholder="Ingrese el nombre del producto" />
            <button type="submit">Buscar</button>
        </form>
    </div>
    
    <section id="seccion_productos">
        <h3 style="background-color:  #ffe599; text-align: center;">Productos</h3>
        <ul id="lista_prod">
        </ul>
    </section>

    <div id='map' style='width:70%; height: 720px;'></div>
    <script>
        function getProducts() {
            let l1 = {
                id_local: 1,
                nombre: "Paqui vegan",
                direccion: "Las Heras 1550",
                latitud: -37.31462408093658,
                longitud: -59.126362262363045,
            }
            let l2 = {
                id_local: 2,
                nombre: "Corcho vegan",
                direccion: "MuÃ±oz 1260",
                latitud: -37.309305997824744,
                longitud: -59.16011427136577,
            }

            let p1 = {
                id: 1,
                name: "Pan de coco",
                pic: "perro.jpg",
                vegetariano: true,
                vegano: true,
                celiaco: false,
                stock: 100,
                precio: 2500,
                promedio: 4,
                locales: [l1, l1, l1, l1],
            }
            let p2 = {
                id: 2,
                name: "Hamburguesa de lentejas",
                pic: "perra.jpg",
                vegetariano: true,
                vegano: true,
                celiaco: false,
                stock: 100,
                precio: 5000,
                promedio: 5,
                locales: [l2],
            }
            return [p1, p2, p1]
        }

        function createMarker(long, lat) {
            return marker = new mapboxgl.Marker()
                .setLngLat([long, lat]);
        }

        function add_markers(products) {
            let markers = [];
            let current_markets = [];
            products.forEach(p => {
                p.locales.forEach(local => {
                    if (current_markets.length == 0){
                        marker = createMarker(local.longitud, local.latitud);
                        marker.addTo(map);
                        marker.setPopup(new mapboxgl.Popup().setHTML("<h3>" + local.nombre + "!</h3>" + "<h4>" + local.direccion + "</h4>"));
                        markers.push(marker);
                        current_markets.push({
                            lat : local.latitud,
                            long : local.longitud,
                        })
                    }else {
                        current_markets.forEach(cm => {
                            if ((cm.long != local.longitud || cm.lat != local.latitud)){
                                marker = createMarker(local.longitud, local.latitud);
                                marker.addTo(map);
                                marker.setPopup(new mapboxgl.Popup().setHTML("<h3>" + local.nombre + "!</h3>" + "<h4>" + local.direccion + "</h4>"));
                                markers.push(marker);
                            }
                        });
                    }
                });
            });
            return markers;
        }

        async function changeLocationAndZoom(longitude, latitude, zoomLevel) {
            await new Promise(resolve => {
                map.panTo([longitude, latitude]);
                map.once('moveend', () => { // Wait for the map to finish panning
                    resolve();
                });
            });

            map.zoomTo(zoomLevel); // Zoom to new level after pan
        }

        document.getElementById('searchForm').addEventListener('submit', function(event) {
            current_markers.forEach(m => {
                m.remove()
                current_markers.pop(m);
            });
            current_products.forEach(p => {
                current_markers.pop(p);
            });
            
            event.preventDefault(); // Evita que el formulario se envÃ­e de manera tradicional
            let query = document.getElementById('query').value; // Obtiene el valor del campo de entrada
            var datos = document.getElementById('lista_prod');
            datos.innerHTML = '';
            current_products = getProducts();
            
            current_markers = add_markers(current_products);
            current_products.forEach(p => {
                if (p.locales.length == 1) {
                    boton = '<button class="localButton" id="' + p.locales[0].id_local + '">' + p.locales[0].nombre + '</button><br>';
                    datos.innerHTML += '<li class="elem_prod_li">' + '<p>' + p.name + '</p>' + '<img class="imagen" src="/img/' + p.id + '.jpg"/>' + boton + '</li>';
                } else {
                    var lista_locales = '<ul id="lista_prod">';
                    p.locales.forEach(local => {
                        lista_locales += '<button class="localButton" id="' + local.id_local + '">' + local.nombre + '</button><br>';
                    });
                    lista_locales += '</ul>';
                    datos.innerHTML += '<li class="elem_prod_li">' + '<p>' + p.name + '</p>' + '<img class="imagen" src="/img/' + p.id + '.jpg"/>' + lista_locales + '</li>';
                }
            });
            current_products.forEach(p => {
                console.log(p.name);
            });
            
            
            document.querySelectorAll('.localButton').forEach(button => {
                button.addEventListener('click', async function() {
                    try {
                        // Realiza una peticiÃ³n fetch al backend para obtener los datos del local
                        const response = await fetch(`/getLocales?id=${button.id}`);
                        const data = await response.json();
                        changeLocationAndZoom(data.longitud, data.latitud, 17)
                    } catch (error) {
                        console.error('Error al obtener los locales:', error);
                    }
                });
            });
        });
        var current_products = [];
        var current_markers = [];
        // CÃ³digo para el mapa y marcadores
        let lat = -37.32100277545416;
        let long = -59.1348577718957;
        mapboxgl.accessToken = 'pk.eyJ1IjoiY29ya2xvZyIsImEiOiJjbHhxY2hrYTYwenRtMmtvZThlZXQ5anpiIn0.kHrU6lbo-ik_Tx7F4WAv-Q';
        const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v12', // style URL
            center: [long, lat], // starting position [lng, lat], 
            zoom: 13, // starting zoom
        });



    </script>
    
</body>
</html>
